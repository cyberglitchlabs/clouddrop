name: Update UniFi Dashboards

on:
  schedule:
    - cron: '0 3 * * *' # daily at 3am UTC
  workflow_dispatch:

jobs:
  update-unifi-dashboards:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download latest UniFi dashboards
        run: |
          mkdir -p kubernetes/apps/observability/grafana/app/dashboards
          cd kubernetes/apps/observability/grafana/app/dashboards
          base_url="https://raw.githubusercontent.com/unpoller/dashboards/refs/heads/master/v2.0.0"
          dashboards=(
            "UniFi-Poller_%20Client%20Insights%20-%20Prometheus.json"
            "UniFi-Poller_%20Client%20DPI%20-%20Prometheus.json"
            "UniFi-Poller_%20Network%20Sites%20-%20Prometheus.json"
            "UniFi-Poller_%20UAP%20Insights%20-%20Prometheus.json"
            "UniFi-Poller_%20USG%20Insights%20-%20Prometheus.json"
            "UniFi-Poller_%20USW%20Insights%20-%20Prometheus.json"
          )
          for dash in "${dashboards[@]}"; do
            echo "Downloading $dash..."
            curl -fsSLO "$base_url/$dash"
          done
          
          # Rename files to replace %20 with dashes (ConfigMap keys can't contain %)
          for file in *%20*.json; do
            newname=$(echo "$file" | sed 's/%20/-/g')
            mv "$file" "$newname"
            echo "Renamed: $file -> $newname"
          done
          
          # Replace datasource template variables with actual datasource name
          # The Grafana sidecar doesn't perform datasource substitution, so we need to do it here
          for file in UniFi-Poller_*.json; do
            echo "Processing datasource variables in $file..."
            sed -i 's/\${DS_PROMETHEUS}/Prometheus/g' "$file"
          done

      - name: Check for changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add kubernetes/apps/observability/grafana/app/dashboards/UniFi-Poller_*.json
          git diff --cached --exit-code || echo "Dashboards updated"

      - name: Create Pull Request
        if: ${{ steps.check-for-changes.outcome == 'failure' }}
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6
        with:
          commit-message: "chore: update UniFi dashboards from upstream"
          title: "Update UniFi dashboards from upstream"
          body: "Automated update of UniFi dashboards from https://github.com/unpoller/dashboards."
          branch: update/unifi-dashboards
          delete-branch: true
