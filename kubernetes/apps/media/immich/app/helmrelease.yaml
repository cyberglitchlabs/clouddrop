---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
  namespace: media
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: immich-charts
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  dependsOn:
    - name: cloudflare-tunnel
      namespace: network
  values:
    controllers:
      main:
        containers:
          main:
            image:
              tag: v2.4.1
            env:
              # Redis connection
              REDIS_HOSTNAME: immich-valkey
              # Machine learning URL
              IMMICH_MACHINE_LEARNING_URL: http://immich-machine-learning:3003
              # Database connection (using CNPG with VectorChord)
              DB_VECTOR_EXTENSION: vectorchord
              DB_HOSTNAME: immich-postgres-rw
              DB_PORT: "5432"
              DB_DATABASE_NAME: app
              DB_USERNAME:
                valueFrom:
                  secretKeyRef:
                    name: immich-postgres-app
                    key: username
              DB_PASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: immich-postgres-app
                    key: password

    immich:
      metrics:
        enabled: true
      persistence:
        library:
          existingClaim: immich-photos
          globalMounts:
            - path: /usr/src/app/upload

    # Enable built-in Valkey (Redis)
    valkey:
      enabled: true
      controllers:
        main:
          containers:
            main:
              image:
                repository: docker.io/valkey/valkey
                tag: 9.0-alpine
      persistence:
        data:
          enabled: true
          type: persistentVolumeClaim
          storageClass: qnap-nfs
          size: 1Gi
          accessMode: ReadWriteOnce

    # Server component
    server:
      enabled: true
      controllers:
        main:
          containers:
            main:
              resources:
                requests:
                  cpu: 100m
                  memory: 512Mi
                limits:
                  memory: 2Gi

    # Machine learning component with NVIDIA GPU
    machine-learning:
      enabled: true
      controllers:
        main:
          containers:
            main:
              image:
                repository: ghcr.io/immich-app/immich-machine-learning
                tag: v2.4.1-cuda
              resources:
                requests:
                  cpu: 100m
                  memory: 512Mi
                  nvidia.com/gpu: 1
                limits:
                  memory: 8Gi
                  nvidia.com/gpu: 1
          pod:
            nodeSelector:
              kubernetes.io/hostname: tuf1
            runtimeClassName: nvidia
      persistence:
        cache:
          enabled: true
          type: persistentVolumeClaim
          storageClass: qnap-nfs
          size: 10Gi
          accessMode: ReadWriteOnce

    # Gateway API HTTPRoute for external access
    route:
      main:
        enabled: true
        parentRefs:
          - name: external
            namespace: kube-system
            sectionName: https
        hostnames:
          - immich.${SECRET_DOMAIN}
        rules:
          - backendRefs:
              - name: immich-server
                port: 2283
